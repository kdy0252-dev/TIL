---
id: 4. Spring Batch Chunk
started: 2025-02-24
last modified: 2025-02-24
tags:
  - ✅DONE
group: "[[Java Spring Batch]]"
---
# 4. Spring Batch Chunk

## Chunk
Chunk란 여러 개의 아이템들을 묶은 하나의 덩어리, 블록을 의미한다.
한 번에 하나씩 아이템을 입력받아 Chunk라는 단위의 덩어리로 만든 후 Chunk단위로 트랜잭션을 처리한다. 즉 Chunk 단위의 Commit과 Rollback이 일어난다.
![[Pasted image 20250224091322.png]]
![[Pasted image 20250224091331.png]]
![[Pasted image 20250224091342.png]]
사용법은 아래와 같다.
```Java title="Spring Batch Chunk 사용 방법 1"
    private final BatchTestRepository batchTestRepository;
    private final EntityManagerFactory entityManagerFactory;
	
    @Bean
    public Step dbModifierStep(
        JobRepository jobRepository,
        PlatformTransactionManager transactionManager) {
        return new StepBuilder("myStep2", jobRepository)
            .<BatchTestEntity, BatchTestEntity>chunk(5, transactionManager)
            .reader(reader())
            .processor(processor())
            .writer(writer())
            .build();
    }
	
    @Bean
    public JpaPagingItemReader<BatchTestEntity> reader() {
        return new JpaPagingItemReaderBuilder<BatchTestEntity>()
            .name("jpaReader")
            .entityManagerFactory(entityManagerFactory) // JPA EntityManagerFactory 주입
            .queryString("SELECT b FROM BatchTestEntity b") // JPQL 쿼리
            .pageSize(5) // 한 번에 가져올 데이터 크기
            .build();
    }
	
    @Bean
    public ItemProcessor<BatchTestEntity, BatchTestEntity> processor() {
        return item -> {
            item.setName(item.getName() + "_modified");
            log.info("Processor modified item: {}", item);
            return item;
        };
    }
	
    @Bean
    public JpaItemWriter<BatchTestEntity> writer() {
        JpaItemWriter<BatchTestEntity> writer = new JpaItemWriter<>();
        writer.setEntityManagerFactory(entityManagerFactory);
        return writer;
    }
```
아래와 같이 JPA Repository를 사용하는 방법도 있다.
```Java title="Spring Batch Chunk 사용 방법 2"
@Bean
public RepositoryItemReader<BatchTestEntity> reader2() {
    return new RepositoryItemReaderBuilder<BatchTestEntity>()
        .name("repositoryReader") // Reader 이름
        .repository(batchTestRepository) // Repository 주입
        .methodName("findByAll") // 호출할 Repository 메서드
        .arguments("ACTIVE") // Repository 메서드에 전달할 파라미터
        .sorts(Collections.singletonMap("id", Sort.Direction.ASC)) // 정렬 기준
        .build();
}
```

### Database 기반 ItemReader
#### a. JpaPagingItemReader
- **설명**: JPA를 사용하여 데이터베이스에서 데이터를 페이징 처리하며 읽어옵니다.
- **특징**:
    - JPQL 기반 쿼리.
    - 페이징을 통해 메모리 효율적으로 대량 데이터를 처리.
- **사용 사례**: JPA/Hibernate 기반 프로젝트에서 엔티티를 처리할 때.
#### b. JdbcPagingItemReader
- **설명**: JDBC를 사용하여 SQL 기반으로 데이터를 페이징 처리하며 읽어옵니다.
- **특징**:
    - 순수 SQL 쿼리를 사용.
    - 페이징 및 정렬 지원.
- **사용 사례**: JPA를 사용하지 않는 순수 SQL 기반 프로젝트에서.
### 파일 기반 ItemReader
#### a. FlatFileItemReader
- **설명**: CSV, 텍스트 파일 등의 데이터를 읽어옵니다.
- **특징**:
    - 파일을 한 줄씩 읽어 처리.
    - 데이터 파싱 및 매핑을 위한 `LineMapper` 지원.
- **사용 사례**: 파일로부터 데이터를 읽어야 하는 경우.
### In-Memory 기반 ItemReader
#### a. ListItemReader
- **설명**: 메모리 상의 리스트 데이터를 순차적으로 읽어옵니다.
- **특징**:
    - 간단한 테스트 및 소규모 데이터 처리에 유용.
    - 페이징 기능 없음.
- **사용 사례**: 테스트 또는 메모리 내 데이터 처리.
### Message 기반 ItemReader
#### a. KafkaItemReader
- **설명**: Kafka 토픽에서 메시지를 읽습니다.
- **특징**:
    - 스트리밍 데이터를 처리.
    - Kafka와 통합.
- **사용 사례**: 실시간 스트리밍 데이터 처리.
### Custom ItemReader
 설명: 사용자의 요구에 따라 직접 `ItemReader` 인터페이스를 구현하여 맞춤형 Reader를 작성.
 
 **특징**:
- 어떤 데이터 소스에서든 데이터를 읽어올 수 있음.
- 높은 유연성과 확장성 제공.

| Reader               | 데이터 소스          | 페이징 지원 | 사용 사례               |
| -------------------- | --------------- | ------ | ------------------- |
| JpaPagingItemReader  | JPA             | O      | JPA 엔티티를 페이징하며 읽을 때 |
| JdbcPagingItemReader | SQL             | O      | SQL 기반으로 데이터를 읽을 때  |
| RepositoryItemReader | Spring Data JPA | O      | Repository 메서드 호출 시 |
| FlatFileItemReader   | 파일 (CSV, 텍스트)   | X      | 파일로부터 데이터를 읽을 때     |
| ListItemReader       | 메모리 리스트         | X      | 테스트나 소규모 데이터 처리 시   |
| KafkaItemReader      | Kafka 메시지       | X      | 스트리밍 데이터 처리 시       |
| Custom ItemReader    | 커스텀 데이터 소스      | X      | 특수한 요구 사항에 맞게 구현 시  |
|                      |                 |        |                     |
# Reference
[Spring Batch JpaPagingItemReader + JpaItemWriter를 사용했 때겪었던 문제점 (1)](https://newwisdom.tistory.com/129)
[스프링 배치 청크 프로세스 이해](https://tonylim.tistory.com/433)