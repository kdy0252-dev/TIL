---
id: Spring Batch Domain
started: 2025-02-24
last modified: 2025-02-24
tags:
  - ✅DONE
group: "[[Java Spring Batch]]"
---
# Spring Batch Domain

## Spring Batch Job의 주요 개념
### 1. Job
배치 작업의 논리적 묶음을 나타낸다.
각 Job은 고유한 이름으로 식별된다.
내부적으로 **Step**의 순서를 정의하며, 이를 통해 작업 흐름(Flow)을 제어한다.
### 2. Step
Job을 구성하는 개별 작업 단위다.
하나의 Step은 주로 **Reader → Processor → Writer** 패턴으로 구성된다.
각 Step은 독립적으로 실행되고, **StepExecution**을 통해 상태를 기록한다.
### 3. JobInstance
**Job**의 실행을 나타내는 엔티티다.
같은 Job이 여러 번 실행될 경우, 각 실행은 고유한 `JobInstance`로 구분된다.
동일한 파라미터로 실행된 Job은 같은 JobInstance를 재사용한다.
### 4. JobExecution
JobInstance의 특정 실행을 나타낸다.
실행 상태(SUCCESS, FAILED 등)와 시작 및 종료 시각을 기록한다.

---

## Spring Batch Job의 구성 요소

### 1. Job
예제 코드
```Java
@Slf4j
@Configuration
@RequiredArgsConstructor
public class SpringBatchJobConfig {
    @Bean("MYJOB")
    public Job myJob(JobRepository jobRepository, Step myStep) {
        return new JobBuilder("myJob", jobRepository)
            .start(myStep)
            .build();
    }
	
    @Bean("MYJOB2")
    public Job myJobB(JobRepository jobRepository, Step myStep2) {
        return new JobBuilder("myJob2", jobRepository)
            .start(myStep2)
            .build();
    }
}
```


---

### 2. Step
- Job을 구성하는 핵심 단위로, 실제 데이터 처리 로직이 들어간다.
예제코드
```Java
@Slf4j
@Configuration
public class SpringBatchStepConfig {
    @Bean
    public Step myStep(JobRepository jobRepository, Tasklet myTasklet, PlatformTransactionManager transactionManager) {
        return new StepBuilder("myStep", jobRepository)
            .tasklet(myTasklet, transactionManager) // or .chunk(chunkSize, transactionManager)
            .build();
    }
	
    @Bean
    public Step myStep2(
        JobRepository jobRepository,
        Tasklet myTasklet2,
        PlatformTransactionManager transactionManager) {
        return new StepBuilder("myStep2", jobRepository)
            .tasklet(myTasklet2, transactionManager) // or .chunk(chunkSize, transactionManager)
            .build();
    }
	
    @Bean
    public Tasklet myTasklet() {
        return (contribution, chunkContext) -> {
            log.info(">>>>> This is Step1");
            return RepeatStatus.FINISHED;
        };
    }
	
    @Bean
    public Tasklet myTasklet2() {
        return (contribution, chunkContext) -> {
            log.info(">>>>> This is Step2");
            return RepeatStatus.FINISHED;
        };
    }
}
```

---

### 3. JobLauncher
- Job을 실행하는 데 사용되는 컴포넌트다.
- Job과 JobParameters를 받아 Job을 실행한다.
#### JobLauncher를 사용한 Job 실행
```Java
    private final JobLauncher jobLauncher;
    @Qualifier("MYJOB") private final Job myJob;
    @Qualifier("MYJOB2") private final Job myJob2;
	
    @GetMapping("/batch")
    public ResponseEntity<Void> runBatch() throws Exception {
        log.info("job name: {}", myJob.getName());
        jobLauncher.run(myJob, new JobParameters());
		
        return ResponseEntity.ok().build();
    }

    @GetMapping("/batch2")
    public ResponseEntity<Void> runBatch2() throws Exception {
        log.info("job name: {}", myJob2.getName());
        jobLauncher.run(myJob2, new JobParameters());
		
        return ResponseEntity.ok().build();
    }
```


---

### 4. JobParameters
- Job 실행 시 제공되는 입력값이다.
- 동일한 Job이더라도, 서로 다른 파라미터로 실행하면 새로운 `JobInstance`가 생성된다.
- `JobParameters`는 Immutable(불변)하며, 다음 타입의 값을 지원한다:
    - `String`, `Long`, `Double`, `Date`
- 같은 `JobParameters`로 요청을 2번 수행하게 되면 `JobInstanceAlreadyCompleteException` 이라는 예외를 발생시킨다.
#### JobParameters 예시

```Java
//생성 시
private JobParameters getJobParameter(String date) {
    JobParameter<String> jobParameter = new JobParameter<>(date, String.class);
	
    return new JobParameters(Map.of("run date", jobParameter));
}

//tasklet에서 사용 시
@Bean
public Tasklet myTasklet() {
    return (contribution, chunkContext) -> {
        JobParameters jobParameters = chunkContext.getStepContext()
                                                      .getStepExecution()
                                                      .getJobExecution()
                                                      .getJobParameters();
		
        String runDate = jobParameters.getString("run date");
        log.info(">>>>> This is Step1: {}", runDate);
        return RepeatStatus.FINISHED;
    };
}
```

---

## Spring Batch Job의 실행 흐름

1. **JobExecution** 생성
    - `JobLauncher`가 Job 실행 요청을 받으면, 새로운 `JobExecution` 객체를 생성한다.
2. **StepExecution** 수행
    - Job의 각 Step이 순차적으로 실행된다.
    - Step의 성공/실패 여부는 `StepExecution` 객체에 기록된다.
3. **JobExecution 종료**
    - 모든 Step이 성공적으로 실행되면 Job은 **COMPLETED** 상태로 종료된다.
    - Step 실패 시 Job은 **FAILED** 상태로 종료된다.

---
## Job 실행 상태
Spring Batch는 Job 실행 상태를 추적하여 성공/실패를 관리한다:

| 상태            | 설명                                |
| ------------- | --------------------------------- |
| **STARTING**  | Job 실행이 시작되기 전 상태                 |
| **STARTED**   | Job 실행 중                          |
| **COMPLETED** | Job이 성공적으로 완료됨                    |
| **FAILED**    | Job 실행 중 하나 이상의 Step이 실패          |
| **STOPPING**  | Job 실행 중지 요청을 수락했지만 아직 중지되지 않은 상태 |
| **STOPPED**   | Job 실행이 중지됨                       |
| **UNKNOWN**   | Job 상태를 알 수 없는 경우                 |

---

## Spring Batch Job의 특징
1. **Restartable**
    - Spring Batch Job은 **중단된 지점에서 재실행 가능**하도록 설계되었다.
    - `JobRepository`가 실행 상태를 저장하므로, 실패한 Step 이후부터 실행을 재개할 수 있다.
2. **Flow Control**
    - 여러 Step을 조건에 따라 실행하거나 분기할 수 있다.
    - 예: `Decider`를 사용한 조건 기반 흐름 제어.
3. **Parallel Execution**
    - 멀티스레드나 분산 처리를 통해 Job을 병렬로 실행할 수 있다.

## Job Validator
Job을 구성할때 Validator를 사용하여 Paramaters를 검증 한 후 Job을 실행 시킬 수 있다.
```Java title='Validator 등록 예시'
public class BatchExampleParameterValidator implements JobParametersValidator {
    @Override
    public void validate(JobParameters parameters) throws JobParametersInvalidException {
        if (parameters == null) {
            throw new IllegalArgumentException("parameters must not be null");
        }
        if (!parameters.getParameters().containsKey("run date")) {
            throw new IllegalArgumentException("Parameter must contain 'run date'");
        }
    }
}
```

```Java title='Job Bean 등록 예시'
    @Bean("MYJOB")
    public Job myJob(JobRepository jobRepository, Step myStep) {
        return new JobBuilder("myJob", jobRepository)
            .validator(new BatchExampleParameterValidator())
            .start(myStep)
            .build();
    }
```

위와 같이 우리가 커스텀하게 Validator를 구현 할 수도 있지만 Batch에서는 DefaultJobParametersValidator를 이미 구현해놨다. 따라서 아래와 같이 사용 할 수도 있다.

```Java title='Spring Batch 기본 Validator 사용 예시'
    @Bean("MYJOB")
    public Job myJob(JobRepository jobRepository, Step myStep) {
        return new JobBuilder("myJob", jobRepository)
            .validator(new DefaultJobParametersValidator(
                Stream.of("run date").toArray(String[]::new),
                Stream.empty().toArray(String[]::new)))
            .start(myStep)
            .build();
    }
```
## PreventRestart
Job이 성공하지 못하였더라도 다시 시작 할 수 없게 만드는 기능이다.
```Java title='Job이 성공하지 못하였더라도 다시 시작하지 못하게 하는 예시'
    @Bean("MYJOB")
    public Job myJob(JobRepository jobRepository, Step myStep) {
        return new JobBuilder("myJob", jobRepository)
            .validator(new BatchExampleParameterValidator())
            .start(myStep)
            .preventRestart() // 이렇게만 추가해줘도 이 Job은 동일 파라미터로는 다시는 시작 할 수 없다.
            .build();
    }
```
## Incrementer
기존의 JobParameter를 사용하여 Job을 여러번 수행하고 싶을때 사용한다.
JobParameters에서 필요한 값을 증가시켜서 다음에 사용될 JobParameters 오브젝트를 리턴한다.
기본적으로 RunIdIncrementer 구현체를 지원하며 인터페이스를 직접 구현 할 수도 있다.
```Java title="Run Id Incrementer 사용 예시"
    @Bean("MYJOB")
    public Job myJob(JobRepository jobRepository, Step myStep) {
        return new JobBuilder("myJob", jobRepository)
            .validator(new BatchExampleParameterValidator())
            .start(myStep)
            .incrementer(new RunIdIncrementer())
            .build();
    }
```

파라미터에 1씩 증가하는 Long type의 파라미터를 추가하여 Job을 재실행한다.
아래와 같이 CustomIncrementer를 작성해서 사용 할 수 있다.

```Java title="Custom Incrementer 사용 예시"
public class BatchExampleParametersIncrementer implements JobParametersIncrementer {
	
    private static final SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
	
    @NonNull
    @Override
    public JobParameters getNext(JobParameters parameters) {
        String id = dateFormat.format(LocalDateTime.now(ZoneId.systemDefault()));
		
        return new JobParametersBuilder(parameters).addString("date", id).toJobParameters();
    }
}
```

대신 이때 JobLauncher로 직접 사용하게 되었을때는 적용되지 않으므로 주의해서 사용해야한다.

JobLauncher로 사용시 아래와 같이 사용하면 된다.

JobLauncher

```Java title="JobLauncher 사용 예시"
@Slf4j
@Controller
@RequiredArgsCon
structor
public class BatchController {

    private final JobLauncher jobLauncher;
    @Qualifier("MYJOB") private final Job myJob;
    private final JobExplorer jobExplorer;
    //@Qualifier("MYJOB2") private final Job myJob2;

    @GetMapping("/batch")
    public ResponseEntity<Void> runBatch() throws Exception {

        log.info("job name: {}", myJob.getName());

        jobLauncher.run(myJob, getJobParameter("12월3일"));

        return ResponseEntity.ok().build();
    }
    
    private JobParameters getJobParameter(String date) {
        return new JobParametersBuilder(jobExplorer)
            .getNextJobParameters(myJob)
            .addString("run date", date)
            .toJobParameters();
    }
}
```

Custom Incrementer

```Java title="Custom Incrementer 사용 예시"
public class BatchExampleParametersIncrementer implements JobParametersIncrementer {
    @NonNull
    @Override
    public JobParameters getNext(JobParameters parameters) {
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
        String id = LocalDateTime.now(ZoneId.systemDefault()).format(formatter);
		
        return new JobParametersBuilder(parameters).addString("date", id).toJobParameters();
    }
}
```

Job

```Java title="Job 사용 예시"
@Bean("MYJOB")
public Job myJob(JobRepository jobRepository, Step myStep) {
    return new JobBuilder("myJob", jobRepository)
        .incrementer(new BatchExampleParametersIncrementer())
        .start(myStep)
        .build();
}
```
### 2. Step
Step은 Job의 실행 단위이며 tesklet이라고 불리우는 작업의 단위를 실행시켜준다.  
Step은 Job과 1대 다로 매핑이 될 수 있고 마지막 스텝의 실행 결과가 JobExecution에 저장된다.  
Step은 아래와 같이 Step Builder를 사용하여 구성 할 수 있다.

```Java title="Step 사용 예시"
@Bean
public Step myStep(JobRepository jobRepository, Tasklet myTasklet, PlatformTransactionManager transactionManager) {
    return new StepBuilder("myStep", jobRepository)
        .tasklet(myTasklet, transactionManager) // or .chunk(chunkSize, transactionManager)
        .build();
}
```

Step Builder의 종류는 아래와 같다.
#### TaskletStepBuilder
TaskletStep을 생성하는 기본 빌더 클래스이다. 내부적으로 Tasklet을 생성하여 실행한다.
#### SimpleStepBuilder
TaskletStep을 생성하며 내부적으로 청크기반의 작업을 수행하는 ChunkOrientedTasklet을 생성하여 실행한다.
#### PartitionStepBuilder
PartitionStep을 생성하며 멀티 스레드 방식으로 Job을 수행한다.
#### JobStepBuilder
JobStep을 생성하여 Step안에서 Job을 실행한다.
#### FlowStepBuilder
FlowStep을 생성하여 Step안에서 Flow를 실행한다.

# Reference
[jobLauncher로 Job 실행시 runIdIncrementer가 작동하지 않는 경우](https://kafcamus.tistory.com/46)
[스프링 배치 실행 - Step](https://tonylim.tistory.com/431)