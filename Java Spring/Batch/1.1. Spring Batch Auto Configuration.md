---
id: 1.1. Spring Batch Auto Configuration
started: 2025-02-24
last modified: 2025-02-24
tags:
  - ✅DONE
group: "[[Java Spring Batch]]"
---
# Spring Batch Auto Configuration
`package org.springframework.boot.autoconfigure.batch;` 경로에 존재하는 파일이다.
### BatchAutoConfiguration 코드의 주요 구성
#### 1. 클래스 레벨 어노테이션
```Java title="BatchAutoConfiguration 어노테이션 내부"
@AutoConfiguration(
    after = {HibernateJpaAutoConfiguration.class, TransactionAutoConfiguration.class}
)
@ConditionalOnClass({JobLauncher.class, DataSource.class, DatabasePopulator.class})
@ConditionalOnBean({DataSource.class, PlatformTransactionManager.class})
@ConditionalOnMissingBean(
    value = {DefaultBatchConfiguration.class},
    annotation = {EnableBatchProcessing.class}
)
@EnableConfigurationProperties({BatchProperties.class})
@Import({DatabaseInitializationDependencyConfigurer.class})

```
- `@AutoConfiguration`: Spring Boot의 자동 구성 클래스임을 나타냅니다. Hibernate 및 트랜잭션 자동 구성 이후에 실행됩니다.
- `@ConditionalOnClass`: `JobLauncher`, `DataSource`, `DatabasePopulator` 클래스가 클래스패스에 존재할 때만 실행됩니다.
- `@ConditionalOnBean`: `DataSource`와 `PlatformTransactionManager` 빈이 존재해야 실행됩니다.
- `@ConditionalOnMissingBean`: **사용자가 직접 설정한** `DefaultBatchConfiguration`**이나** `@EnableBatchProcessing`**이 존재하지 않을 경우**에만 실행됩니다.
- `@EnableConfigurationProperties`: **`BatchProperties`**를 사용해 설정 속성을 매핑합니다.
- `@Import`: 데이터베이스 초기화 의존성을 관리하는 `DatabaseInitializationDependencyConfigurer`를 가져옵니다.
#### 2. JobLauncherApplicationRunner

```Java title="JobLauncherApplicationRunner 어노테이션 내부"
@Bean
@ConditionalOnMissingBean
@ConditionalOnProperty(
    prefix = "spring.batch.job",
    name = {"enabled"},
    havingValue = "true",
    matchIfMissing = true
)
public JobLauncherApplicationRunner jobLauncherApplicationRunner(JobLauncher jobLauncher, JobExplorer jobExplorer, JobRepository jobRepository, BatchProperties properties) {
    JobLauncherApplicationRunner runner = new JobLauncherApplicationRunner(jobLauncher, jobExplorer, jobRepository);
    String jobName = properties.getJob().getName();
    if (StringUtils.hasText(jobName)) {
        runner.setJobName(jobName);
    }
    return runner;
}
```
**역할**:
- Spring Boot에서 Job 실행을 관리하는 `JobLauncherApplicationRunner` 빈을 등록합니다.
- `spring.batch.job.enabled=true`일 경우 활성화되며, 기본적으로 **첫 번째 등록된 Job**을 자동 실행합니다.
- 실행할 Job 이름은 `spring.batch.job.name` 속성에서 가져옵니다.

#### 3. JobExecutionExitCodeGenerator
```Java title="JobExecutionExitCodeGenerator 어노테이션 내부"
@Bean
@ConditionalOnMissingBean({ExitCodeGenerator.class})
public JobExecutionExitCodeGenerator jobExecutionExitCodeGenerator() {
    return new JobExecutionExitCodeGenerator();
}
```
**역할**:
- 배치 Job 실행 결과를 **애플리케이션의 종료 코드**로 반환하는 빈을 등록합니다.
- 배치 Job이 실패하면 **비정상 종료 코드**를 반환할 수 있습니다.
#### 4. OnBatchDatasourceInitializationCondition
```Java title="OnBatchDatasourceInitializationCondition 어노테이션 내부"
static class OnBatchDatasourceInitializationCondition extends OnDatabaseInitializationCondition {
    OnBatchDatasourceInitializationCondition() {
        super("Batch", new String[]{"spring.batch.jdbc.initialize-schema", "spring.batch.initialize-schema"});
    }
}
```
**역할**:
- 데이터베이스 초기화 조건을 정의하는 클래스입니다.
- `spring.batch.jdbc.initialize-schema` 또는 `spring.batch.initialize-schema` 설정 값을 확인하여 **스키마 초기화 여부**를 결정합니다.
#### 5. DataSourceInitializerConfiguration
```Java title="DataSourceInitializerConfiguration 어노테이션 내부"
@Configuration(proxyBeanMethods = false)
@Conditional({OnBatchDatasourceInitializationCondition.class})
static class DataSourceInitializerConfiguration {
    @Bean
    @ConditionalOnMissingBean({BatchDataSourceScriptDatabaseInitializer.class})
    BatchDataSourceScriptDatabaseInitializer batchDataSourceInitializer(DataSource dataSource, @BatchDataSource ObjectProvider<DataSource> batchDataSource, BatchProperties properties) {
        return new BatchDataSourceScriptDatabaseInitializer((DataSource)batchDataSource.getIfAvailable(() -> dataSource), properties.getJdbc());
    }
}
```
**역할**:
- Spring Batch 메타데이터 테이블을 초기화하는 `BatchDataSourceScriptDatabaseInitializer` 빈을 등록합니다.
- `spring.batch.jdbc.initialize-schema` 설정에 따라 **데이터베이스 초기화 스크립트**를 실행합니다.
#### 6. SpringBootBatchConfiguration
```Java title="SpringBootBatchConfiguration 어노테이션 내부"
@Configuration(proxyBeanMethods = false)
static class SpringBootBatchConfiguration extends DefaultBatchConfiguration {
    // 데이터 소스, 트랜잭션 매니저, BatchProperties 등을 받아 초기화
    ...
}
```
**역할**:
- Spring Batch의 기본 설정을 제공하는 **`DefaultBatchConfiguration`**을 확장합니다.
- 다음과 같은 컴포넌트를 제공:
    - `JobRepository`
    - `JobLauncher`
    - `JobExplorer`
    - `TransactionManager`
- `BatchProperties` 설정 값을 기반으로 **스키마 접두어(Table Prefix)**, **격리 수준(Isolation Level)** 등을 커스터마이징합니다.
- `BatchConversionServiceCustomizer` 및 `ExecutionContextSerializer`를 통해 데이터 변환과 직렬화를 유연하게 지원합니다.
### 실행 흐름 요약
```
BatchAutoConfiguration
    ├── JobLauncherApplicationRunner
    │      ├── JobLauncher
    │      ├── JobExplorer
    │      ├── JobRepository
    │      └── BatchProperties
    ├── JobExecutionExitCodeGenerator
    ├── OnBatchDatasourceInitializationCondition
    │      └── DataSourceInitializerConfiguration
    │             └── BatchDataSourceScriptDatabaseInitializer (DB 스키마 초기화)
    └── SpringBootBatchConfiguration (extends DefaultBatchConfiguration)
           ├── DataSource
           ├── TransactionManager
           ├── BatchProperties
           ├── BatchConversionServiceCustomizer
           └── ExecutionContextSerializer
```
### **결론**
- **`BatchAutoConfiguration`**은 Spring Boot에서 Spring Batch 애플리케이션을 자동 설정하기 위한 핵심 클래스입니다.
- `SpringBootBatchConfiguration`을 통해 Spring Batch의 기본 설정(`JobLauncher`, `JobRepository`, `JobExplorer`, 등)을 제공합니다.
- 데이터 소스 초기화(`BatchDataSourceScriptDatabaseInitializer`), Job 자동 실행(`JobLauncherApplicationRunner`), 종료 코드 반환(`JobExecutionExitCodeGenerator`) 등 Spring Batch 애플리케이션의 전반적인 실행 흐름을 관리합니다.
- 설정을 커스터마이징하려면 필요한 빈들을 직접 정의하거나, 속성(`spring.batch.*`)을 조정하면 됩니다.
# Reference