---
id: Spring Batch 5 Config
started: 2025-02-24
last modified: 2025-02-24
tags:
  - ✅DONE
  - Java
  - Spring
  - Batch
group: "[[Java Spring Batch]]"
---
# Spring Batch 5 Config

## 초기화
Spring Batch 초기화 설정은 4개의 설정 클래스들의 객체를 초기화 하면서 이루어진다.  
이 방법은 수동으로 하는 방식과 Spring Boot에서 자동으로 하는 방식이 존재한다.

![[Pasted image 20250224084911.png]]

Batch 초기화 과정

초기화 설정 클래스들은 아래의 4가지로 이루어져있다.

1. BatchAutoConfiguration  
    스프링 배치가 초기화 될 때 자동으로 실행되는 설정 클래스이다.  
    Job을 수행하는 `JobLauncherApplicationRunner` 빈을 생성하는데  
    `JobLauncherApplicationRunner`가 Spring 서버가 기동될때 빈으로 등록된 Job들을 실행시켜준다.

2. SimpleBatchConfiguration  
    `JobBuilderFactory`와 `StepBuilderFactory`를 생성해주는데  
    이것들은 Spring Batch 5에서는 Deprecated 되었다.  
    이 외에도 스프링 배치의 주요 구성 요소들을 생성해준다. → 프록시 객체

3. BatchConfigurerConfiguration  
    이 설정 클래스는 내부에 두가지의 설정 클래스를 가지고 있다  
      
    `BasicBatchConfigurer`  
    SimpleBatchConfigration에서 생성한 프록시 객체의 실제 대상 객체를 생성하는 설정 클래스이다.  
    빈을 통해 의존성 주입을 받아서 주요 객체들을 참조해서 사용 할 수 있다.  
      
    `JpaBatchConfigurer`  
    Jpa 관련 객체를 생성하는 설정 클래스이다.  

사용자 정의 `BatchConfugurer` 인터페이스를 구현하여 사용 할 수 있다.

이 과정은 Spring Batch 4에서는  
Application과 각 구성요소에 `@EnableBatchProcessing`이라는 어노테이션을 달아줌으로써 이루어지지만  
Spring Batch 5에서는  
`@EnableBatchProcessing` 을 사용하면 아래와 같은 이슈가 있다.

> [!INFO] **Spring Batch 5에서** `@EnableBatchProcessing` **이슈의 원인**
> 1. Spring Boot 3의 배치 자동 설정 개선:
>     - Spring Boot 3부터는 Spring Batch를 사용할 때 `BatchAutoConfiguration`이 기본적으로 **자동으로 배치 인프라를 설정**해준다.
>     - 하지만`BatchAutoConfiguration`은 `@ConditionalOnMissingBean` 어노테이션으로 `@EnableBatchProcessing`이 없을때 초기화를 하므로 Batch 설정이 자동으로 진행되지 않을 수 있다.
>         `@ConditionalOnMissingBean( value = {DefaultBatchConfiguration.class}, annotation = {EnableBatchProcessing.class} )`
>     - 이로 인해 `JobRepository`, `JobLauncher` 등의 핵심 배치 컴포넌트가 제대로 초기화되지 않는 문제가 발생할 수 있다.
>         
> 2. 중복 설정:
>     - `@EnableBatchProcessing`은 **기본 배치 설정을 명시적으로 활성화**하지만, Spring Boot의 자동 구성(`BatchAutoConfiguration`)과 동시에 동작하면 설정이 겹쳐서 초기화 문제가 생긴다.
>         
> 3. Java Configuration 방식 권장:
>     - Spring Batch 5에서는 `@EnableBatchProcessing` 대신 **순수 Java Configuration** 방식으로 설정하는 것이 권장된다.
>     - `DefaultBatchConfiguration`이나 `BatchConfigurer`를 상속해서 필요에 따라 배치 설정을 명확하게 정의하는 것이 더 나은 방법이다.
## Spring Batch 5의 초기화 과정
Spring Boot 3버전과 Spring Batch 5를 동시에 사용하게 된다면 아래와 같이 BatchAutoConfiguration으로 Batch 설정을 초기화 하게 된다.

Spring Boot 어플리케이션에서부터 따라가보자면

`@Modulith` → `@SpringBootApplication` → `AutoConfigurationImportSelector.class` → META-INF에 AutoConfiguration.imports 내에 등록된 `BatchAutoConfiguration`

`BatchAutoConfiguration`이후 초기화되는 과정은 아래와 같다.


```
BatchAutoConfiguration 
	├── JobLauncherApplicationRunner (Job 실행) 
	│    ├── JobLauncher
	│    ├── JobExplorer
	│    ├── JobRepository
	│    └── BatchProperties
	│
	├── JobExecutionExitCodeGenerator (Job 결과를 종료 코드로 반환)\
	│    ├── OnBatchDatasourceInitializationCondition (DB 스키마 초기화 여부 확인) 
	│    └── DataSourceInitializerConfiguration (SQL 스크립트 실행)
	│
	└── SpringBootBatchConfiguration extends DefaultBatchConfiguration (Datasource, Transaction Manager 등등)
```

> [!INFO] BatchAutoConfiguration의 코드 상세 설명은 아래 문서 참고
> [[Spring] BatchAutoConfiguration](https://auto-jira.atlassian.net/wiki/spaces/V2X2/pages/1656750305)
> 위 문서를 보면 application.yml 파일의 설정을 어떻게 가져가는지 직접 볼 수 있음.

따라서 Spring Batch 5에서는 `application.yml` 파일이나 명시적인 빈 등록을 통해서 초기화 하도록 권장하고 있다.

`application.yml`파일에는 다음과 같은 설정이 있는데 아래와 같은 의미가 있다.

`batch: job: enabled: false jdbc: initialize-schema: always`

batch.job.enabled 설정은 Spring Boot Application이 기동될때 자동으로 Job을 실행하도록 할지 설정하는 것이다.

batch.job.enabled가 true이고 batch.job.name이 있으면 해당 Job의 name과 일치하는 배치 작업을 자동으로 서버가 기동될때 실행해준다.

batch.jdbc.initialize-schma 설정의 경우에는 batch가 사용하는 DB 메타 테이블이 있는데 이 스키마를 자동으로 초기화 할 것인지 설정하는 부분이다. always를 사용하게 되면 항상 초기화를 진행하도록 설정 할 수 있다. `embedded` 설정과 `never` 설정이 있다.
## DefaultBatchConfiguration
SpringBootBatchConfiguration은 DefaultBatchConfiguration을 상속받아 구현되는데 이 부분의 코드를 보면

아래와 같은 종류의 빈들을 만들어 등록하게 된다.

`JobRepository` `JobLauncher` `JobExplorer` `JobRegistry` `JobOperator` `JobRegistryBeanPostProcessor`

이 과정에서 생성되는 빈들은 Spring Batch 4에서와는 다르게 Proxy 객체를 사용하는 것이 아니라 직접 객체를 생성하여 사용한다.

> [!INFO] 왜 Spring Batch 5에서 Proxy 사용이 제거되었는가?
> 1. Spring Framework의 발전
> Spring Batch 5는 Spring Boot 3.x와 Jakarta EE 9+로 업그레이드되면서, Spring Framework의 현대적 기능을 활용해 Proxy 없이 트랜잭션을 명확히 처리할 수 있게 되었다.
>
> 2. 설정 단순화
> Proxy를 사용하면 실행 시점의 동작이 복잡해질 수 있다.
> Spring Batch 5에서는 컴포넌트를 명확하게 정의하고 직접 객체를 생성함으로써 설정 및 디버깅이 간소화되었다.
> 
> 3. 트랜잭션 관리의 명확성
> Proxy를 통해 트랜잭션을 관리하면, Spring AOP의 동작 방식에 따라 실행 시점에 예상치 못한 문제가 발생할 수 있다.
> Spring Batch 5는 트랜잭션 처리를 `PlatformTransactionManager`로 직접 관리하여 이러한 문제를 줄였다.

# Reference