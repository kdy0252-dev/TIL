---
id: K6 설치방법
started: 2025-04-17
tags:
  - ✅DONE
group: "[[부하테스트]]"
---
# K6 설치
## 데몬 설치 방법 (Ubuntu, Docker)
### Host Machine

```shell title="Ubuntu에서 설치방법"
sudo gpg -k
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```
### Docker

```shell title="Docker 이미지로 설치하는 방법"
docker pull grafana/k6

#We also have a separate image you can use with chromium installed to run k6 browser tests.
docker pull grafana/k6:master-with-browser
```
## K6 Operator 설치
Operator는 여러 인스턴스에서 동시에 부하테스트를 수행하기에 좀 더 강도높은 부하테스트가 가능하다.
```shell title="쿠버네티스 마스터노드에서 Operator 설치"
git clone https://github.com/grafana/k6-operator && cd k6-operator  
make deploy
```

## 사용법
### 스크립트 작성
```js title="부하테스트 스크립트"
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  stages: [
    { target: 200, duration: '30s' },
    { target: 0, duration: '30s' },
  ],
};

export default function () {
  const result = http.get('https://test-api.k6.io/public/crocodiles/');
  check(result, {
    'http response status code is 200': result.status === 200,
  });
}
```
### 스크립트 실행
```shell title="K6 스크립트 실행"
k6 run scripts.js
```

### 결과 확인
![[Pasted image 20250418090849.png]]

### K6 스크립트 ConfigMap 생성
```shell title="클러스터에 K6 스크립트 ConfigMap 생성"
kubectl create configmap <ConfigMap 이름> --from-file <스크립트 파일 경로>

# 위를 실행하면 아래와 같이 출력됨
configmap/<ConfigMap 이름> created
```

### K6-Operator 이미지 변경

기본적으로 k6-operator는 테스트 작업의 컨테이너 이미지로 `grafana/k6:latest`를 사용한다. xk6로 빌드된 확장을 사용하려면 자체 이미지를 생성하고 k6 쿠버네티스 배포 리소스에서 이미지 속성을 바꿔서 배포해야 한다.

```dockerfile title="DockerFile"
# Build the k6 binary with the extension
FROM golang:1.18.1 as builder

RUN go install go.k6.io/xk6/cmd/xk6@latest
RUN xk6 build --output /k6 --with github.com/grafana/xk6-output-prometheus-remote@latest

# Use the operator's base image and override the k6 binary
FROM grafana/k6:latest
COPY --from=builder /k6 /usr/bin/k6
```

```shell title="위 DockerFile로 Docker를 빌드한다."
docker build -t k6-prometheus:v1 .
```
빌드한 이미지를 원하는 레지스트리에 push하고 image 경로를 기록해 놓는다.

### 리소스 생성
- `arguments: -o xk6-prometheus-rw --tag testid=alb`
    - Prometheus의 실행인자로 위에서 빌드한 이미지의 옵션 값, `tag`의 경우 그라파나 대시보드에 구분자로 사용할 값
- `K6_PROMETHEUS_RW_SERVER_URL`
    - remote write endpoint로 위에 구성한 prometheus endpoint를 기재
- `K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM`
    - 고해상도 히스토그램 형태의 데이터를 보내기 위한 환경 변수 값 (기본값: false)
- `image: k6-prometheus:v1`
    - 위에서 빌드한 Prometheus remote write 기능이 포함된 이미지 레지스트리 경로를 입력
- `configMap`
    - 컨피그맵으로 등록한 부하 스크립트

```yaml title="k6-operator 리소스 yaml 파일"
apiVersion: k6.io/v1alpha1
kind: K6
metadata:
  name: k6-sample
spec:
  arguments: -o xk6-prometheus-rw --tag testid=test
  parallelism: 1
  runner:
    env:
    - name: K6_PROMETHEUS_RW_SERVER_URL
      value: http://kube-prometheus-stack-prometheus.monitoring:9090/api/v1/write
    - name: K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM
      value: "true"
    image: k6-prometheus:v1
  script:
    configMap:
      file: scritps.js
      name: test-script

```

```shell title="resource 적용"
kubectl apply -f k6-resource.yaml
```

이렇게 설정을 하면 Grafana에서 부하테스트 결과를 볼 수 있다.

# Reference
[공식 홈페이지 Documentation](https://grafana.com/docs/k6/latest/set-up/install-k6/)
[한글 메뉴얼](https://github.com/schooldevops/k6-tutorials/blob/main/GettingStarts/01_intro_install.md)