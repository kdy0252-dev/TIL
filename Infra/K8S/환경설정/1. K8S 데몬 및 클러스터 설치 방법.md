---
id: K8S 설치 방법
started: 2025-02-24
last modified: 2025-02-24
tags:
  - ✅DONE
  - k8s
group:
  - "[[K8S]]"
---
# K8S 데몬 및 클러스터 설치 방법

## 가상머신에 설치 시 
### 1. Rocky Linux 설치
아래 이미지대로 진행
![[Pasted image 20250224124036.png]]
![[Pasted image 20250224131913.png]]
- 설치 목적지 설정
	디스크 하나 선택 후 완료버튼
- 네트워크와 호스트 이름 설정
	ipv4 설정 고정 IP로 설정, 호스트 이름 k8s-master
- root 비밀번호 설정
	ssh 접속 가능하도록 체크

## 필요 패키지 및 ContainerD 설치 (dnf를 써도 된다.)
### yum 패키지 버전 확인 및 설치방법
``` title="패키지 버전 확인 예시 두번째 라인은 외부 저장소 사용시"
yum list --showduplicates containerd.io
yum list --showduplicates containerd.io --disableexcludes=kubernetes
```
### K8S와 ContainerD 버전 Pair 확인
[ContainerD와 K8S 버전 Pair 확인](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl)
### yum repository update
`yum -y update`
### wget, vim 설치
`yum -y install wget vim`
### 타임 존 설정
`timedatectl set-timezone Asia/Seoul`
### /etc/hosts 추가
``` title="/etc/hosts 마지막라인에 추가"
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

<Host IP> k8s-master

또는

echo "<Host IP> k8s-master" | tee -a /etc/hosts
```
### 방화벽 해제
`systemctl stop firewalld systemctl disable firewalld`
### Swap 비활성화
`swapoff -a`
### ContainerD 설치 및 실행
```shell title="Container D 설치"
yum -y install dnf-plugins-core
yum config-manager --add-repo https://download.docker.com/linux/rhel/docker-ce.repo
yum -y install containerd.io-1.6.33-3.1.el9.aarch64
systemctl enable --now containerd
containerd config default > /etc/containerd/config.toml
sed -i 's/ SystemdCgroup = false/ SystemdCgroup = true/' /etc/containerd/config.toml
systemctl restart containerd
```
1.7.25-3.1.el8 버전을 설치하였음.
## K8S패키지 설치 및 서비스 데몬 실행
[![](https://kubernetes.io/icons/favicon-16.png)Installing kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl)
**K8S 1.32 버전 설치시에는 아래 명령어를 입력한다.**
```shell title="k8s 1.32 버전 설치시에 실행한다."
# Set SELinux in permissive mode (effectively disabling it)
setenforce 0
sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
```
### Repository 등록
K8S 1.32 버전의 경우에는 아래
```shell title="1.32 버전 설치시에 실행"
# This overwrites any existing configuration in /etc/yum.repos.d/kubernetes.repo
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.32/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.32/rpm/repodata/repomd.xml.key
exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
EOF
```
**하지만 우리는 ContainerD 버전을 1.6.33을 사용하고 있기때문에 K8S를 1.31버전 이상을 설치 할 수 없으므로 아래로 진행한다.**
``` shell title="k8s 1.30버전 설치시에 실행한다."
# This overwrites any existing configuration in /etc/yum.repos.d/kubernetes.repo
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.30/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.30/rpm/repodata/repomd.xml.key
exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
EOF
```
### K8S 패키지 설치
`yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes`
### K8S 서비스 데몬 실행
`systemctl enable --now kubelet`
## K8s Cluster 실행 및 Calico 설치 (Master Node)
[tutorial: Quickstart on Kubernetes | Calico Documentation](https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart)
### ipv4 포워드 설정
`echo "net.ipv4.ip_forward = 1" | tee -a /etc/sysctl.conf sysctl -p`
### K8S Cluster init **(Master Node)**
```shell title="k8s 클러스터 init"
kubeadm init --pod-network-cidr=<파드네트워크로 쓸 IP 주소/프리픽스> --apiserver-advertise-address=<API 서버 주소 입력>

# example
# kubeadm init --pod-network-cidr=192.168.0.0/16 --apiserver-advertise-address=192.168.77.2

mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
```
**cidr 주소를 바꾸려면 아래 명령을 실행해야함.**
```shell title="cidr 주소 바꿀 시에 custom-resources 파일에 cidr 주소를 입력해주어야함."
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.29.2/manifests/tigera-operator.yaml
curl -O https://raw.githubusercontent.com/projectcalico/calico/v3.29.2/manifests/custom-resources.yaml
sed -i 's/cidr: 192\.168\.0\.0\/16/cidr: <파드네트워크로 쓸 IP 주소>\/16/g' custom-resources.yaml
kubectl apply -f custom-resources.yaml
```
### K8S Cluster Join **(Worker Node)**
마스터 노드에서 kube init 후에 나온 token과 join 정보 스크립트를 worker 노드에서 실행하면 된다.
```shell title="Join 예시"
kubeadm join 10.19.2.171:6443 --token 4mikiv.k0hclqxswjd19xwl --discovery-token-ca-cert-hash sha256:591d33a7c7cfaffd9ae94b5f7c2e634a050f404e23ba103367fc5dd0f420671a
```
**아래 과정은 다시 Master Node에서만 진행하면 된다.**
### Master Node에서 Worker Node가 잘 Join 되었는지 확인
```shell title="Worker가 잘 Join 되었는지 마스터노드에서 확인"
[root@exscms1 ~]# kubectl get nodes -o wide
NAME      STATUS   ROLES           AGE     VERSION    INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                            KERNEL-VERSION                  CONTAINER-RUNTIME
exscms1   Ready    control-plane   99m     v1.30.10   10.19.2.170   <none>        Rocky Linux 8.10 (Green Obsidian)   4.18.0-553.22.1.el8_10.x86_64   containerd://1.7.25
exscms2   Ready    <none>          6m41s   v1.30.10   10.19.2.170   <none>        Rocky Linux 8.10 (Green Obsidian)   4.18.0-553.22.1.el8_10.x86_64   containerd://1.7.25
exscms3   Ready    <none>          35s     v1.30.10   10.19.2.170   <none>        Rocky Linux 8.10 (Green Obsidian)   4.18.0-553.22.1.el8_10.x86_64   containerd://1.7.25
exscms4   Ready    <none>          22s     v1.30.10   10.19.2.170   <none>        Rocky Linux 8.10 (Green Obsidian)   4.18.0-553.22.1.el8_10.x86_64   containerd://1.7.25
```
### Calico Node 설치
```shell title="calico-system node 생성 및 확인"
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.29.2/manifests/tigera-operator.yaml
sleep 3
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.29.2/manifests/custom-resources.yaml
watch kubectl get pods -n calico-system
```

**마스터노드에서 어플리케이션이 파드가 설치되도록 하려면 아래 명령어 실행**
`kubectl taint nodes k8s-master node-role.kubernetes.io/control-plane:NoSchedule-`
### calicoctl plugin 설치
```shell title="CalicoCtl Plugin 설치"
curl -L https://github.com/projectcalico/calico/releases/download/v3.29.2/calicoctl-linux-arm64 -o kubectl-calico
chmod +x kubectl-calico
```
### Dashboard 설치
- wget -O k8s-dashboard.yaml https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
- 접속시 로그인으로 Token 인증 하도록 되어있는데 인증 생략을 넣어주자
	- Deployment -> args
	- - --enable-skip-login
- Pods, Namespace, Service 등 리소스에 접근 할 권한이 없기 때문에 아래 코드를 넣어주자
```yaml title="dashboard node config"
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubernetes-dashboard2
  labels:
    k8s-app: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
```
#### 우리는 이미 설정한 k8s-dashboard.yaml 파일이 있기에 해당 파일을 쓰면 된다.
Yaml File: [[k8s-DashBoard.yaml]]
```shell title="k8s-dashboard.yaml 적용"
kubectl apply -f k8s-dashboard.yaml
```
### Metrics Server 설치
- wget -O metrics-server.yaml https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/high-availability-1.21+.yaml
- Kubelet으로 인증하도록 되어있는데 인증 생략을 넣어주자
	- Deployment -> args
	- - --kubelet-insecure-tls 추가
#### 우리는 이미 설정한 metrics-server.yaml 파일이 있기에 해당 파일을 쓰면 된다.
Yaml File: [[metrics-server.yaml]]
```shell title="metrics-server.yaml 적용"
kubectl apply -f metrics-server.yaml
```
## 더미노드 실행 후 노드의 IP 대역 확인하는 방법
### 임시 Pod 실행
```shell title="임시 Pod 실행"
kubectl run dummy-node --image=busybox --restart=Never -- sleep 3600
# 수동으로 삭제하려면 아래 커맨드 실행
kubectl delete pod dummy-node
```
- `--rm`: Pod가 종료되면 자동 삭제
- `-it`: 인터랙티브 모드 (쉘 접속 가능)
- `--image=busybox`: 가벼운 Linux 컨테이너 이미지 사용
- `--restart=Never`: 단일 실행 후 종료 (Job 형태)
### Pod IP 대역 확인
`kubectl get pod dummy-node -o wide`
### Node IP 대역 확인
`kubectl get node -o wide`
### 클러스터 IP 대역 확인
`kubectl get services -o wide`
### 클러스터 정보 출력
`kubectl cluster-info`
## K8S Master Node 설치 스크립트
스크립트 파일: [[K8S-Install.sh]]

# Reference